# ============================================================
# RCMDT Protocol v4 - 统一实验配置规范
# ============================================================
# 目的：建立不可争辩的统一口径，确保所有实验可复现、可审计
# 创建日期：2026-01-09
# 语言规范：所有输出、思考、任务清单均使用中文
# ============================================================

version: "4.0"
created: "2026-01-09"
purpose: "彻底重做 RCMDT 论文实验体系，统一口径，确保可复现"

# ============================================================
# 1. 数据切分协议 (Data Split Protocol)
# ============================================================
# 重要说明：
# - 时间均为香港时间 (HKT = UTC+8)
# - 没有 AM Peak 数据
# - 可用数据集：
#   1. data/  -> 2025-12-19 PM Peak (HKT 17:00-18:00)
#   2. data2/ -> 2025-12-30 Off-Peak (HKT 15:00-16:00)
# ============================================================

data_split:
  description: "可用数据场景（无 AM Peak）"
  
  # 可用场景 1: PM Peak (data/)
  pm_peak:
    date: "2025-12-19"
    data_folder: "data"
    hkt_time: "17:00-18:00"
    utc_time: "09:00-10:00"
    utc_start_sec: 32400
    utc_end_sec: 36000
    duration_sec: 3600
    usage: "calibration"
    
  # 可用场景 2: Off-Peak (data2/)
  off_peak:
    date: "2025-12-30"
    data_folder: "data2"
    hkt_time: "15:00-16:00"
    utc_time: "07:00-08:00"
    utc_start_sec: 25200
    utc_end_sec: 28800
    duration_sec: 3600
    usage: "transfer_validation"
    note: "论文主线场景 P14"
  
  window_unit: "1-hour sliding windows"
  
  # 注意：AM Peak 数据不可用
  am_peak_available: false
  
# ============================================================
# 2. Audit 观测算子协议 (Observation Operator Protocol)
# ============================================================
audit:
  description: "Op-L2-v1.1 观测算子审计规则"
  version: "Op-L2-v1.1"
  
  # Rule C: 核心过滤规则
  rule_c:
    description: "固定去污染规则，分离 transport 和 non-transport regimes"
    travel_time_threshold:
      symbol: "T*"
      value: 325
      unit: "seconds"
      condition: ">="
    speed_threshold:
      symbol: "v*"
      value: 5
      unit: "km/h"
      condition: "<="
    logic: "flagged = (T >= T*) AND (v_eff <= v*)"
    
  # 输出定义
  outputs:
    flagged:
      description: "被标记为 non-transport regime 的样本"
      calculation: "满足 Rule C 条件的 D2D 样本"
    clean:
      description: "transport regime 样本（用于验证）"
      calculation: "不满足 Rule C 条件的 D2D 样本"
    flagged_fraction:
      description: "被过滤样本的比例"
      calculation: "n_flagged / n_raw"
      unit: "ratio [0, 1]"
    n_clean:
      description: "清洗后的样本数量"
      minimum_valid: 10
      na_condition: "n_clean < 10 时标记为 NA"
    n_raw:
      description: "原始样本数量"
    n_sim:
      description: "仿真样本数量"

  # Audit 在校准中的角色
  calibration_role:
    description: "Audit 是否进入 L1 校准"
    options:
      - id: "A0"
        name: "Zero-shot"
        l1_uses_audit: false
        l2_enabled: false
        description: "默认参数，无 L2，无 audit"
      - id: "A1"
        name: "Raw-L1"
        l1_uses_audit: false
        l2_enabled: false
        description: "L1 用 raw D2D（无 audit gating），无 L2"
      - id: "A2"
        name: "Audit-for-Validation-Only"
        l1_uses_audit: false
        l2_enabled: false
        validation_uses_clean: true
        description: "L1 仍用 raw，但验证只看 clean"
      - id: "A3"
        name: "Audit-in-Calibration"
        l1_uses_audit: true
        l2_enabled: false
        description: "L1 只在 clean 集上算 loss"
      - id: "A4"
        name: "Full-RCMDT"
        l1_uses_audit: true
        l2_enabled: true
        description: "A3 + L2(IES) - 完整 RCMDT"

# ============================================================
# 3. 指标定义 (Metrics Definition)
# ============================================================
metrics:
  description: "所有指标的严格定义"
  
  # KS 统计量
  ks_distance:
    description: "两样本 Kolmogorov-Smirnov 距离"
    
    ks_speed:
      description: "基于速度 CDF 的 KS 距离"
      target: "link_speed (km/h)"
      calculation: "sup_x |F_n(x) - G_m(x)|"
      use_case: "主要验证指标（与外部 IRN 可比）"
      
    ks_tt:
      description: "基于 D2D 行程时间 CDF 的 KS 距离"
      target: "door_to_door_travel_time (seconds)"
      calculation: "sup_x |F_n(x) - G_m(x)|"
      use_case: "校准目标对应的验证指标"
      
  # Pass/Fail 判据
  pass_fail:
    description: "KS 检验的通过/失败判据"
    alpha: 0.05
    critical_value:
      formula: "D_crit = 1.36 * sqrt((n + m) / (n * m))"
      c_alpha: 1.36
      note: "c(0.05) = 1.36 for two-sample KS test"
    pass_condition: "KS < D_crit"
    fail_condition: "KS >= D_crit"
    
  # Worst-window 定义
  worst_window:
    description: "最差 15 分钟子窗口的严格定义"
    method: "exhaustive"
    window_size: 15
    unit: "minutes"
    step: 1
    unit_step: "minute"
    calculation: |
      1. 将 1 小时切分为所有可能的连续 15 分钟子窗口
      2. 起始点从 :00 到 :45，每分钟一个（共 46 个子窗口）
      3. 对每个子窗口计算 KS 距离
      4. 取最大 KS 值作为 worst-window KS
      5. 输出最差窗口的起止时间
    output:
      - worst_window_ks_speed
      - worst_window_ks_tt
      - worst_window_start_time
      - worst_window_end_time
    note: "禁止使用 random sub-windows"
    
  # Bootstrap 置信区间
  bootstrap_ci:
    description: "跨窗口汇总的置信区间"
    method: "bootstrap"
    confidence_level: 0.95
    n_bootstrap: 1000
    output:
      - mean
      - median
      - ci_lower
      - ci_upper
      
  # 其他指标
  other_metrics:
    rmse:
      description: "均方根误差"
      formula: "sqrt(1/n * sum(e_i^2))"
      unit: "seconds"
    mae:
      description: "平均绝对误差"
      formula: "1/n * sum(|e_i|)"
      unit: "seconds"
    p90:
      description: "90th 分位数误差"
      formula: "quantile(|e|, 0.90)"
      unit: "seconds"

# ============================================================
# 4. 统一运行预算 (Run Budget Protocol)
# ============================================================
run_budget:
  description: "确保所有方法公平比较的运行预算"
  
  # L1 优化器预算
  l1_optimizer:
    total_iterations: 40
    lhs_initial: 15
    bo_iterations: 25
    description: "15 次 LHS 初始采样 + 25 次 BO 优化"
    
  # SUMO 仿真预算
  sumo:
    replications_per_candidate: 1
    max_simulation_time: 3600
    unit: "seconds"
    description: "每个候选参数配置运行 1 次完整 1 小时仿真"
    
  # 随机种子
  random_seeds:
    master_seed: 42
    seed_set: [42, 123, 456, 789, 1024]
    description: "固定种子集合确保可复现性"
    
  # 跨方法对比约束
  baseline_comparison:
    constraint: "same_budget"
    description: "所有优化器/smoother 方法必须使用相同的 SUMO runs budget"

# ============================================================
# 5. L2 Smoother 配置 (IES/ES-MDA/EnRML 参数)
# ============================================================
l2_smoother:
  description: "L2 层 Smoother 的可复现配置"
  
  # 状态向量定义
  state_vector:
    x_corr:
      description: "背景状态向量（corridor background）"
      components:
        - name: "capacityFactor"
          description: "路段通行能力因子"
          bounds: [0.5, 3.0]
        - name: "minGap"
          description: "最小跟车间距"
          bounds: [0.5, 5.0]
          unit: "meters"
        - name: "impatience"
          description: "驾驶员不耐烦度"
          bounds: [0.0, 1.0]
      dimension: 3
      note: "d = 3 (可扩展)"
      
  # 观测向量定义
  observation_vector:
    y:
      description: "观测向量（corridor observation）"
      components:
        - name: "link_speed"
          description: "路段平均速度"
          unit: "km/h"
        - name: "segment_count"
          description: "有效样本数"
      dimension: "p = n_links * 2"
      note: "每条 link 两个观测量"
      
  # 公共参数
  common_parameters:
    ensemble_size:
      symbol: "Ne"
      value: 20
      description: "集合成员数量"
    max_iterations:
      symbol: "K"
      value: 5
      description: "最大迭代次数"
    time_window:
      start: 61200  # 17:00 in seconds
      end: 64800    # 18:00 in seconds
      duration: 3600
      unit: "seconds"
    observation_error:
      R_type: "diagonal"
      R_source: "empirical"
      variance_floor: 1.0
      unit: "(km/h)^2"
      inflation: false
      description: "观测误差协方差矩阵 R"
    update_damping:
      beta: 0.3
      description: "更新阻尼系数"
    feasibility_projection:
      method: "clip"
      bounds: "parameter_bounds"
      description: "可行性投影（裁剪到边界）"
      
  # 方法特定参数
  method_specific:
    ies:
      source: "Custom (LTPP)"
      localization: "Patch-wise (L=16)"
      nugget_ratio: 0.05
      adaptive_damping: true
    es_mda:
      source: "dapper.mods.iEnKS (MDA mode)"
      alpha_k: "K"  # inflation = K
      localization: "None"
    enrml:
      source: "dapper.mods.iEnKS"
      regularization: "Levenberg-Marquardt"
      localization: "None"
    ienks:
      source: "dapper.mods.iEnKS"
      lag: "Finite-Window"
      localization: "Domain-specific"

# ============================================================
# 6. L1 Stop 参数配置 (Behavioral Parameters)
# ============================================================
l1_stop_parameters:
  description: "L1 层 stop-level 行为参数"
  
  parameters:
    t_board:
      description: "单乘客上车耗时"
      bounds: [0.5, 5.0]
      unit: "seconds"
    t_fixed:
      description: "固定停站开销（开关门）"
      bounds: [5.0, 20.0]
      unit: "seconds"
    tau:
      description: "驾驶员反应时间"
      bounds: [0.1, 2.0]
      unit: "seconds"
    sigma:
      description: "速度偏差系数"
      bounds: [0.1, 0.8]
    minGap:
      description: "最小跟车间距"
      bounds: [0.5, 5.0]
      unit: "meters"
    accel:
      description: "最大加速度"
      bounds: [0.5, 3.0]
      unit: "m/s^2"
    decel:
      description: "最大减速度"
      bounds: [1.0, 5.0]
      unit: "m/s^2"

  # 复合损失函数
  loss_function:
    formula: "J_L1 = RMSE + α*(MAE + λ*std(|e|)) + β*Q_0.9(|e|)"
    components:
      rmse:
        weight: 1.0
        description: "均方根误差项"
      mae_dispersion:
        alpha: 1.0
        lambda: 0.5
        description: "平均绝对误差 + 方差惩罚"
      tail_risk:
        beta: 0.5
        quantile: 0.9
        description: "90 分位数尾部惩罚"

# ============================================================
# 7. 输出目录结构 (Output Directory Structure)
# ============================================================
output_structure:
  base_dir: "data/experiments_v4"
  
  # 禁止使用 .tex 格式，所有表格使用 Markdown (.md)
  # 原因：论文使用 Word 排版，不使用 LaTeX
  
  subdirectories:
    protocol_ablation:
      path: "data/experiments_v4/protocol_ablation"
      description: "Protocol Ablation (A0-A4) 实验结果"
      outputs:
        - results.csv
        - summary.csv
        - tables/ablation_table.md
        - figures/ablation_comparison.png
        
    smoother_baselines:
      path: "data/experiments_v4/smoother_baselines"
      description: "L2 Smoother Baselines (IES/ES-MDA/EnRML) 对比"
      outputs:
        - results.csv
        - summary.csv
        - tables/smoother_comparison.md
        - tables/l2_config_table.md
        - figures/smoother_convergence.png
        
    threshold_sensitivity:
      path: "data/experiments_v4/threshold_sensitivity"
      description: "Audit 阈值敏感性分析"
      outputs:
        - results.csv
        - summary.csv
        - tables/threshold_table.md
        - figures/threshold_heatmap.png
        - figures/pareto_front.png
        
    loss_sensitivity:
      path: "data/experiments_v4/loss_sensitivity"
      description: "损失函数权重敏感性分析"
      outputs:
        - results.csv
        - summary.csv
        - tables/loss_weight_table.md
        - figures/tradeoff_curve.png
        
    optimizer_baselines:
      path: "data/experiments_v4/optimizer_baselines"
      description: "优化器对比 (BO/Random/LHS/CMA-ES)"
      outputs:
        - results.csv
        - summary.csv
        - tables/optimizer_comparison.md
        - figures/convergence_curves.png
        - figures/best_objective_boxplot.png
        
    misflag_incident:
      path: "data/experiments_v4/misflag_incident"
      description: "Misflag/Incident 鲁棒性分析"
      outputs:
        - results.csv
        - case_studies/
        - tables/misflag_table.md
        - figures/incident_analysis.png
        
    global_summary:
      path: "data/experiments_v4/global_summary"
      description: "全研究期统计汇总"
      outputs:
        - results.csv
        - summary.csv
        - tables/global_summary.md
        - figures/ks_distribution.png
        - figures/heatmap_route_period.png
        - figures/pass_rate_bar.png

# ============================================================
# 8. 输出模板要求 (Output Template Requirements)
# ============================================================
output_template:
  description: "每个实验必须输出的标准格式"
  
  required_columns:
    - route
    - period
    - day
    - n_raw
    - n_clean
    - n_sim
    - flagged_fraction
    - ks_speed
    - ks_speed_critical
    - ks_speed_passed
    - ks_tt
    - ks_tt_critical
    - ks_tt_passed
    - worst_window_ks_speed
    - worst_window_ks_tt
    - worst_window_start
    - worst_window_end
    - rmse
    - mae
    - p90
    
  aggregation_columns:
    - mean
    - median
    - std
    - ci_lower_95
    - ci_upper_95
    - pass_rate
    
  # 禁止使用 LaTeX，使用 Markdown 表格（适配 Word 排版）
  markdown_table_format:
    style: "GFM"  # GitHub Flavored Markdown
    caption_required: true
    caption_must_include:
      - metric_type  # speed 或 TT
      - window_definition  # full-hour 或 worst-window
      - n_m_values  # 样本量
      - pass_fail_criterion  # 判据定义
    note: "禁止输出 .tex 文件，所有表格使用 .md 格式"

# ============================================================
# 9. Sanity Checks (完整性检查)
# ============================================================
sanity_checks:
  description: "不通过则报错终止的检查项"
  
  checks:
    - id: "SC1"
      name: "unit_consistency"
      description: "指标单位一致性检查"
      rule: "speed in km/h, time in seconds"
      action: "error_and_abort"
      
    - id: "SC2"
      name: "mask_consistency"
      description: "数据掩码一致性检查"
      rule: "real 和 sim 使用相同的时间窗口和路段定义"
      action: "error_and_abort"
      
    - id: "SC3"
      name: "n_clean_minimum"
      description: "清洗后样本量最小值检查"
      rule: "n_clean >= 10"
      action_if_fail: "mark_as_NA"
      note: "n_clean < 10 时该格标 NA，不允许输出 0.0"
      
    - id: "SC4"
      name: "window_consistency"
      description: "时间窗口一致性检查"
      rule: "real 和 sim 的时间窗口完全对齐"
      action: "error_and_abort"
      
    - id: "SC5"
      name: "ks_range"
      description: "KS 值范围检查"
      rule: "0 <= KS <= 1"
      action: "error_and_abort"
      
    - id: "SC6"
      name: "no_random_worst_window"
      description: "禁止 random worst-window"
      rule: "worst-window 必须使用 exhaustive 方法"
      action: "error_and_abort"

# ============================================================
# 10. 禁止事项 (Constraints)
# ============================================================
constraints:
  description: "必须遵守的禁止事项"
  
  forbidden:
    - id: "C1"
      description: "禁止混用旧口径数据"
      detail: "random worst-15min、B4(v0) 作为主线、单位不一致、mask 不一致"
      
    - id: "C2"
      description: "禁止 n_clean 太小却输出 0.0"
      detail: "n_clean < 10 时必须标 NA"
      
    - id: "C3"
      description: "禁止图表缺少必要信息"
      detail: "caption 必须写清 metric 对象、窗口定义、n,m、pass/fail 判据"
      
    - id: "C4"
      description: "禁止直接计算 KS"
      detail: "任何实验脚本不得自行计算 KS，必须调用 metrics_v4.py"
      
    - id: "C5"
      description: "禁止复用 B4(v0) 作为主线证据"
      detail: "B4(v0) 可作为 legacy mechanism 放 appendix，不作为主线"

# ============================================================
# 11. 路由与场景配置 (Routes & Scenarios)
# ============================================================
routes:
  primary:
    - route_id: "68X"
      direction: "Inbound"
      description: "元朗 -> 旺角 (密集城区)"
      role: "minimization_target"
      
    - route_id: "960"
      direction: "Inbound"
      description: "湾仔 -> 屯门 (过海线路)"
      role: "constraint_anchor"
      constraint_threshold: 350  # seconds RMSE
      penalty_coefficient: 10.0

scenarios:
  primary: "P14"
  description: "Off-Peak transfer (15:00-16:00)"
  data_sources:
    real: "data2/processed/link_stats_offpeak.csv"
    sim: "offpeak_v2_offpeak_stopinfo.xml"
  external_check: "IRN segment speeds (traffic-only)"

# ============================================================
# 12. 版本历史 (Version History)
# ============================================================
version_history:
  - version: "4.0"
    date: "2026-01-09"
    changes:
      - "完整重建实验体系"
      - "统一所有指标定义"
      - "添加 exhaustive worst-window"
      - "添加 bootstrap CI"
      - "禁止 random sub-windows"
      - "要求 n_clean >= 10"
